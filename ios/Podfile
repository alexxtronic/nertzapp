platform :ios, '13.0'

# CocoaPods analytics sends network stats synchronously affecting flutter build latency.
ENV['COCOAPODS_DISABLE_STATS'] = 'true'

project 'Runner', {
  'Debug' => :debug,
  'Profile' => :release,
  'Release' => :release,
}

def flutter_root
  generated_xcode_build_settings_path = File.expand_path(File.join('..', 'Flutter', 'Generated.xcconfig'), __FILE__)
  unless File.exist?(generated_xcode_build_settings_path)
    raise "#{generated_xcode_build_settings_path} must exist. If you're running pod install manually, make sure flutter pub get is executed first"
  end

  File.foreach(generated_xcode_build_settings_path) do |line|
    matches = line.match(/FLUTTER_ROOT\=(.*)/)
    return matches[1].strip if matches
  end
  raise "FLUTTER_ROOT not found in #{generated_xcode_build_settings_path}. Try deleting Generated.xcconfig, then run flutter pub get"
end

require File.expand_path(File.join('packages', 'flutter_tools', 'bin', 'podhelper'), flutter_root)

flutter_ios_podfile_setup

target 'Runner' do
  use_frameworks!

  flutter_install_all_ios_pods File.dirname(File.realpath(__FILE__))
  target 'RunnerTests' do
    inherit! :search_paths
  end
end

post_install do |installer|
  installer.pods_project.targets.each do |target|
    flutter_additional_ios_build_settings(target)
    target.build_configurations.each do |config|
      # Fix for "PhaseScriptExecution failed" by disabling User Script Sandboxing
      config.build_settings['ENABLE_USER_SCRIPT_SANDBOXING'] = 'NO'
      config.build_settings['IPHONEOS_DEPLOYMENT_TARGET'] = '13.0'
    end
  end
  
  # Fix for readlink -f issue on macOS (BSD readlink doesn't support -f) which causes "Command PhaseScriptExecution failed"
  # This section modifies the autogenerated shell scripts from CocoaPods to use a python/bash fallback instead of 'readlink -f'
  puts "üîß Applying 'readlink -f' fix to Pods-Runner-frameworks.sh..."
  
  frameworks_script_path = File.join("Pods", "Target Support Files", "Pods-Runner", "Pods-Runner-frameworks.sh")
  
  if File.exist?(frameworks_script_path)
    text = File.read(frameworks_script_path)
    # This replacement command mimics the logic of `readlink -f` using `dirname` and `pwd -P`
    # We replace strict string matching with a slightly flexible check or just the known target line
    original_cmd = 'source="$(readlink -f "${source}")"'
    replacement_cmd = 'source="$(cd "$(dirname "${source}")" && pwd -P)/$(basename "${source}")"'
    
    if text.include?(original_cmd)
      new_contents = text.gsub(original_cmd, replacement_cmd)
      File.open(frameworks_script_path, "w") { |file| file.puts new_contents }
      puts "‚úÖ 'readlink -f' fix applied successfully!"
    else
      puts "‚ö†Ô∏è  'readlink -f' command not found in frameworks script. It might have been already patched or the script has changed."
    end
  else
    puts "‚ö†Ô∏è  Frameworks script not found at #{frameworks_script_path}"
  end
  
  # Ensure toolchain dir is correct
  installer.pods_project.targets.each do |target|
    target.build_configurations.each do |config|
        base_config = config.base_configuration_reference
        if base_config
            xcconfig_path = base_config.real_path
            if File.exist?(xcconfig_path)
                xcconfig = File.read(xcconfig_path)
                if xcconfig.include?("DT_TOOLCHAIN_DIR")
                    xcconfig_mod = xcconfig.gsub(/DT_TOOLCHAIN_DIR/, "TOOLCHAIN_DIR")
                    File.open(xcconfig_path, "w") { |file| file << xcconfig_mod }
                    puts "‚úÖ DT_TOOLCHAIN_DIR fix applied to #{target.name}"
                end
            end
        end
    end
  end

end
